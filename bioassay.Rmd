---
title: "bioassay"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(gtools)  # inv.logit
```


## Notation
- $k_i$ = number of groups (dose levels)
- $x_i$ = dose for group $i$
- $n_i$ = number of animals in group $i$
- $y_i$ = number of deaths in gropu $i$
- $\theta_i$ = probability of death in group $i$
- $\alpha$ = intercept parameter of logistic regression model
- $\beta$ = slope parameter of logistic regression model


## Assumptions
- Assumption 1: The outcome of the five animals within group i is exchangeable. Model the outcomes of the five animals within group i as independent with the equal probabilities.
- Assumption 2: Give the parameters theta1, theta2, theta3, theta4, treat the outcomes in the four groups as indepent from each other

## Data
```{r}
x <- c(-0.86, -0.3, -0.05, 0.73)
n <- c(5, 5, 5, 5)
y <- c(0, 1, 3, 5)
df <- data.frame(x=x, n=n, y=y)
df
```

## Dose-response relation
Model the dose-response relation with logistic regression model. The function $logit$ is defined  $$logit(\theta_i) := log\left(\frac{\theta_i}{1-\theta_i}\right).$$ We assume the model
$$logit(\theta_i) = \alpha + \beta x_i.$$ Then
$$\theta_i = logit^{-1}(\alpha + \beta x_i) := \frac{e^{\alpha + \beta x_i}}{1 + e^{\alpha + \beta x_i}}.$$

## Sampling distribution: 
$$ y_i | \theta_i ~ Bin(n_i, \theta_i) $$ 
If we express $\theta_i$ in terms of $\alpha$ and $\beta$ then 
$$ y_i|\alpha, \beta \propto [logit^{-1}(\alpha + \beta x_i)]^{y_i}[1 - logit^{-1}(\alpha + \beta x_i)]^{ni-yi}$$. Note that $logit^{-1}(x) = \frac{e^x}{1+e^x}$ 
(This treats the sample sizes $n_i$ and dose levels $x_i$ as fixed.)

## Non-informative Prior Distribution
$$p(\alpha, \beta) \propto 1$$

## Joint Posterior Distribution of $\alpha$ and $\beta$
$$p(\alpha, \beta | y) \propto p(\alpha, \beta) \prod_{i=1}^k p(y_i | \alpha, \beta) =
\prod_{i=1}^k [logit^{-1}(\alpha + \beta x_i)]^{y_i}[1 - logit^{-1}(\alpha + \beta x_i)]^{ni-yi}$$ 
(This treats the sample sizes $n_i$ and dose levels $x_i$ as fixed.)


## Rough estimate of paramters 
Perform logistic regression to obtain maximum likelihood estimates of $\alpha$ and $\beta$. This will give us an idea of where to center our grid.
```{r}
regline <- lm(y ~ x, data = df)

ggplot(df) +
  geom_point(aes(x, y)) +
  geom_abline(slope = regline$coefficients[[2]], intercept = regline$coefficients[[1]])
```
The maximum likelihood estimates are $\hat{\alpha}=$ `r regline$coefficients[[1]]` and $\hat{\beta}=$ `r regline$coefficients[[2]]`.

## Compute Unnormalized Posterior Density on Grid 
Recall that the joing posterior density is 
$$p(\alpha, \beta | y) \propto 
\prod_{i=1}^k [logit^{-1}(\alpha + \beta x_i)]^{y_i}[1 - logit^{-1}(\alpha + \beta x_i)]^{ni-yi}$$ 

```{r}
temp_alpha <-regline$coefficients[[1]]
temp_beta <- regline$coefficients[[2]]


temp_theta <- sapply(x, function(xi) gtools::inv.logit(temp_alpha, temp_beta*xi))

```



